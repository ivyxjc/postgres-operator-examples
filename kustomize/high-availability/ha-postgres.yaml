apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
    name: hippo-ha
spec:
    image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres-ha:centos8-13.3-0
    postgresVersion: 13
    instances:
        -   name: pgha1
            replicas: 3
            dataVolumeClaimSpec:
                accessModes:
                    - "ReadWriteOnce"
                resources:
                    requests:
                        storage: 1Gi
            affinity:
                podAntiAffinity:
                    preferredDuringSchedulingIgnoredDuringExecution:
                        -   weight: 1
                            podAffinityTerm:
                                topologyKey: kubernetes.io/hostname
                                labelSelector:
                                    matchLabels:
                                        postgres-operator.crunchydata.com/cluster: hippo-ha
                                        postgres-operator.crunchydata.com/instance-set: pgha1
    backups:
        pgbackrest:
            image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:centos8-2.33-0
            repoHost:
                dedicated: { }
            configuration:
                -   secret:
                        name: pgo-s3-creds
            global:
                repo1-path: /pgbackrest/postgres-operator/hippo-s3/repo1
            repos:
                -   name: repo1
                    schedules:
                        full: "*/1 * * * *"
                        incremental: "*/1 * * * *"
                    s3:
                        bucket: ivy-database-backup-test
                        endpoint: oss-cn-hangzhou.aliyuncs.com
                        region: oss-cn-hangzhou

    proxy:
        pgBouncer:
            image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbouncer:centos8-1.15-0
            replicas: 2
            affinity:
                podAntiAffinity:
                    preferredDuringSchedulingIgnoredDuringExecution:
                        -   weight: 1
                            podAffinityTerm:
                                topologyKey: kubernetes.io/hostname
                                labelSelector:
                                    matchLabels:
                                        postgres-operator.crunchydata.com/cluster: hippo-ha
                                        postgres-operator.crunchydata.com/role: pgbouncer
